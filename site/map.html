<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="config.js"></script>
    <title>Карта - Bike App</title>
    <!-- Шрифты Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Подключаем общий файл стилей, чтобы использовать переменные и меню -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="blend.css">

    <!-- Supabase for user data -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.41.0/dist/umd/supabase.min.js"></script>

    

    <script src="transitions.js" defer></script>
</head>
<body>
<div class="app-screen">
    <!-- Основной контейнер для страницы с картой -->
    <div class="map-page-container">
        <!-- Элемент, в который будет встроена карта -->
        <div id="map"></div>?

        <!-- Кнопка для возврата к своей геопозиции -->
        <button class="recenter-btn" id="recenter-map-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
        </button>

        <!-- Выдвижная информационная карточка -->
        <div class="info-card" id="bike-info-card">
            <div class="card-handle"></div>
            <h3 id="card-address">Выберите точку на карте</h3>
            <div class="card-stats">
                <div class="stat-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="5.5" cy="18.5" r="3.5"></circle>
                        <circle cx="18.5" cy="18.5" r="3.5"></circle>
                        <path d="M15 18.5V11l-3-3-3.5 3H5.5"></path>
                        <path d="M12 8h3"></path>
                    </svg>
                    Свободно: <strong id="card-bikes"></strong>
                </div>
                <div class="stat-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c-4.42 0-8-3.58-8-8a8 8 0 0 1 16 0c0 4.42-3.58 8-8 8z"/><path d="M12 12v-4"/><path d="M12 12H8"/></svg>
                    <span id="card-distance-time"></span>
                </div>
            </div>
            <button class="btn btn-primary" id="route-button">Проложить маршрут</button>
        </div>
    </div>

    <!-- Нижняя навигационная панель -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        </a>
        <a href="stats.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>
        </a>
        <!-- ИСПРАВЛЕНО: Теперь это ссылка, а не DIV, для единообразия -->
        <a href="#" class="nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
        </a>
        <a href="profile.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        </a>
    </nav>
</div>

    <!-- Главное меню Prizmatic -->
    <div id="main-menu-overlay" class="menu-overlay hidden" role="dialog" aria-modal="true">
        <div class="menu-container">
            <button id="main-menu-close-btn" class="menu-close-btn" aria-label="Закрыть меню">&times;</button>
            <div class="menu-items">
                <button class="menu-item-btn primary" id="menu-tariffs-btn">Тарифы Prizmatic</button>
                <button class="menu-item-btn secondary" id="menu-my-rentals-btn">Мои аренды</button>
                <button class="menu-item-btn secondary" id="menu-topup-btn">Пополнить баланс</button>
                <button class="menu-item-btn secondary" id="menu-map-btn">Карта</button>
                <button class="menu-item-btn secondary" id="menu-stats-btn">Статистика</button>
                <button class="menu-item-btn secondary" id="menu-profile-btn">Профиль</button>
                <button class="menu-item-btn secondary" id="menu-support-btn">Поддержка/FAQ</button>
            </div>
        </div>
    </div>



<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', () => {
        // --- ОБЩАЯ ЛОГИКА АНИМАЦИИ ПЕРЕХОДОВ (ДЛЯ ВСЕХ СТРАНИЦ) ---
        const appScreen = document.querySelector('.app-screen');
        const navLinks = document.querySelectorAll('.bottom-nav a.nav-item');
        const animationDuration = 400; // Должно совпадать с transition в CSS

        // Анимация появления страницы
        appScreen.classList.add('page-enter');
        requestAnimationFrame(() => {
            appScreen.classList.remove('page-enter');
            appScreen.classList.add('page-enter-active');
        });

        // Вешаем обработчики на все ссылки навигации
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                // Если клик по уже активной ссылке, ничего не делаем
                if (link.classList.contains('active')) {
                     e.preventDefault();
                     return;
                }

                // Для всех остальных ссылок запускаем анимацию ухода
                e.preventDefault();
                const destination = e.currentTarget.href;

                appScreen.classList.remove('page-enter-active');
                appScreen.classList.add('page-exit');
                requestAnimationFrame(() => {
                    appScreen.classList.add('page-exit-active');
                });

                // Переходим на новую страницу после завершения анимации
                setTimeout(() => {
                    window.location.href = destination;
                }, animationDuration);
            });
        });
    });

    // --- Supabase initialization ---
    const SUPABASE_URL = window.APP_CONFIG.SUPABASE_URL;
    const SUPABASE_ANON_KEY = window.APP_CONFIG.SUPABASE_ANON_KEY;
    let supabase = null;

    // Wait for Supabase to load
    function initSupabase() {
        if (window.supabase && window.supabase.createClient) {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else {
            // Retry after a short delay
            setTimeout(initSupabase, 100);
        }
    }
    initSupabase();

    // City data
    const cityData = {
        'Москва': {
            coords: [55.705072, 37.598672],
            address: '5й Донской проезд д15с13',
            zoom: 14
        },
        'Санкт-Петербург': {
            coords: [59.923419, 30.362895],
            address: 'Лиговский проспект д.50 Н',
            zoom: 14
        },
        'Воронеж': {
            coords: [51.653534, 39.191008],
            address: 'Воронеж, центр',
            zoom: 14
        }
    };

    // --- ЛОГИКА КАРТЫ (ЗАПУСКАЕТСЯ, КОГДА API ГОТОВ) ---
    async function initMapWithData(userCity) {
        // 1. Берем данные для города пользователя или Воронеж по умолчанию
        const cityInfo = cityData[userCity] || cityData['Воронеж'];

        // 2. Создаем карту с центром в этом городе
        let myMap = new ymaps.Map('map', {
            center: cityInfo.coords,
            zoom: cityInfo.zoom,
            controls: []
        });

        // Находим элементы для информационной карточки
        const infoCard = document.getElementById('bike-info-card');
        const cardAddress = document.getElementById('card-address');
        const cardBikes = document.getElementById('card-bikes');

        // 3. Получаем количество доступных велосипедов из базы
        let bikeCount = 0;
        try {
            const { count, error } = await supabase
                .from('bikes')
                .select('*', { count: 'exact', head: true })
                .eq('status', 'available');
            if (!error) {
                bikeCount = count;
            }
        } catch (err) {
            console.error('Error fetching bike count:', err);
        }

        // --- ВОТ ГЛАВНОЕ: ПРОСТО РИСУЕМ ТОЧКУ ---

        // 4. Создаем метку (точку) с координатами из cityInfo
        const bikePlacemark = new ymaps.Placemark(cityInfo.coords, {
            // Это текст, который появится во всплывающем окне при клике
            balloonContent: `<strong>${cityInfo.address}</strong><br>Здесь ${bikeCount} велосипедов`
        }, {
            // Это внешний вид точки
            preset: 'islands#dotIcon',
            iconColor: '#26b999' // Зеленый цвет
        });

        // 5. Добавляем эту точку на карту
        myMap.geoObjects.add(bikePlacemark);

        // Добавим простой обработчик клика, чтобы показывалась карточка
        bikePlacemark.events.add('click', () => {
            cardAddress.textContent = cityInfo.address;
            cardBikes.textContent = bikeCount.toString();
            infoCard.classList.add('visible');
        });
    }

    function loadYandexMaps() {
        const script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = `https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=${window.APP_CONFIG.YANDEX_MAPS_API_KEY}`;
        document.head.appendChild(script);
        script.onload = () => {
            ymaps.ready(async function() {
                const userId = localStorage.getItem('userId');
                let userCity = 'Воронеж'; // default

                if (userId && supabase) {
                    try {
                        const { data: client, error } = await supabase
                            .from('clients')
                            .select('city')
                            .eq('id', userId)
                            .single();
                        if (!error && client && client.city) {
                            userCity = client.city;
                        }
                    } catch (err) {
                        console.error('Error fetching user city:', err);
                    }
                }
                initMapWithData(userCity);
            });
        };
    }

    loadYandexMaps();
</script>
    <script src="menu.js" defer></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Проверяем, что API Telegram доступен
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            
            // Эта команда говорит Telegram, что цвет шапки должен совпадать с фоном нашего приложения
            tg.setHeaderColor('#ffffff');
        }
    });
</script>
</body>
</html>
